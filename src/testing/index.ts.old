import env from "@kosko/env";
import { generate } from "@kosko/generate";
import yaml from "js-yaml";
import { join } from "path";

const generateManifests = async ({ envName, envVars = {} }) => {
  // Set environment
  process.env = {
    ...process.env,
    ...envVars,
  };
  env.env = envName;
  env.cwd = join(__dirname, "..");
  const manifests = await generate({
    components: ["*"],
    path: join(env.cwd, "../components"),
  });
  return manifests;
};

const getEnvManifests = async ({ envName, envVars = {} }) => {
  const manifests = await generateManifests({ envName, envVars });
  if (!manifests.manifests) {
    return null;
  }
  return yaml.safeDump(
    manifests.manifests.map((m) => m.data),
    { noRefs: true }
  );
};

module.exports = { getEnvManifests };
